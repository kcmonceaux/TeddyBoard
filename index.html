<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Teddy Board</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#5D5CDE">
  <meta name="mobile-web-app-capable" content="yes">
  <style>
    :root { --color-primary: #5D5CDE; }
    .theme-ocean { --color-primary: #0ea5e9; }
    .theme-forest { --color-primary: #10b981; }
    .theme-sunset { --color-primary: #f59e0b; }
    .theme-lavender { --color-primary: #8b5cf6; }
    .theme-coral { --color-primary: #f97316; }
    .theme-teal { --color-primary: #14b8a6; }
    .card-hover { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
    .card-hover:active { transform: translateY(0); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="bg-white dark:bg-gray-900 font-sans min-h-screen" onload="init()">

<script>
async function init() {
  // ---------- Theme Selection ----------
  const themeSel = document.getElementById('themeSelector');
  const savedTheme = localStorage.getItem('teddyTheme') || 'theme-default';
  document.body.classList.add(savedTheme);
  themeSel.value = savedTheme;
  themeSel.onchange = e => {
    document.body.classList.remove('theme-ocean','theme-forest','theme-sunset','theme-lavender','theme-coral','theme-teal');
    if(e.target.value!=='theme-default') document.body.classList.add(e.target.value);
    localStorage.setItem('teddyTheme', e.target.value);
  };

  // ---------- Voice Selection ----------
  const voiceSel = document.getElementById('voiceSelector');
  let voices = [];
  function loadVoices() {
    voices = speechSynthesis.getVoices();
    voiceSel.innerHTML = '';
    voices.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v.name;
      opt.textContent = `${v.name} (${v.lang})`;
      voiceSel.append(opt);
    });
    const sv = localStorage.getItem('teddyVoice');
    if(sv) voiceSel.value = sv;
  }
  speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();
  voiceSel.onchange = e => localStorage.setItem('teddyVoice', e.target.value);

  function speak(text) {
    if(!text) return;
    const msg = new SpeechSynthesisUtterance(text);
    const sel = localStorage.getItem('teddyVoice');
    if(sel) msg.voice = voices.find(v=>v.name===sel) || null;
    msg.rate = 0.9;
    speechSynthesis.cancel();
    speechSynthesis.speak(msg);
  }

  // ---------- IndexedDB Setup ----------
  const db = await new Promise((res, rej) => {
    const rq = indexedDB.open('TeddyBoard',1);
    rq.onupgradeneeded = e => {
      const idb = e.target.result;
      idb.createObjectStore('profiles',{ keyPath:'id', autoIncrement:true });
      const items = idb.createObjectStore('items',{ keyPath:'id', autoIncrement:true });
      items.createIndex('byProfile','profileId');
    };
    rq.onsuccess = e => res(e.target.result);
    rq.onerror = e => rej(e.target.error);
  });

  async function getAll(store) {
    const tx = db.transaction(store);
    return tx.objectStore(store).getAll();
  }
  async function put(store, val) {
    const tx = db.transaction(store,'readwrite');
    await tx.objectStore(store).put(val);
  }
  async function del(store, key) {
    const tx = db.transaction(store,'readwrite');
    await tx.objectStore(store).delete(key);
  }
  async function getItemsByProfile(pid) {
    const tx = db.transaction('items');
    const idx = tx.objectStore('items').index('byProfile');
    return new Promise(res=>{
      const arr=[];
      idx.openCursor(pid).onsuccess = ev => {
        const c = ev.target.result;
        if(c) { arr.push(c.value); c.continue(); } else res(arr);
      };
    });
  }

  // ---------- Profile UI ----------
  let currentProfile = null;
  function showProfiles() {
    document.getElementById('profileOverlay').classList.remove('hidden');
    const list = document.getElementById('profileList'); list.innerHTML = '';
    getAll('profiles').then(ps=>ps.forEach(p=>{
      const b = document.createElement('button');
      b.textContent = p.name; b.className='w-full p-3 bg-white rounded';
      b.onclick = ()=>{
        const pw = prompt(`Password for ${p.name}`);
        if(pw===p.password) { currentProfile = p; document.getElementById('profileOverlay').classList.add('hidden'); loadBoard(); }
        else alert('Incorrect');
      };
      list.append(b);
    }));
  }
  document.getElementById('newProfileBtn').onclick = ()=>{
    currentProfile = null;
    document.getElementById('profileModalTitle').textContent='New Profile';
    document.getElementById('profileModal').classList.remove('hidden');
  };
  document.getElementById('cancelProfileBtn').onclick = ()=>document.getElementById('profileModal').classList.add('hidden');
  document.getElementById('saveProfileBtn').onclick = () => {
    const name = document.getElementById('profileName').value.trim();
    const email = document.getElementById('profileEmail').value.trim();
    const password = document.getElementById('profilePassword').value;
    const question = document.getElementById('profileQuestion').value;
    const answer = document.getElementById('profileAnswer').value;
    if(!name||!password) return alert('Name & password required');
    const prof = { id: currentProfile?.id, name, email, password, question, answer };
    put('profiles', prof).then(()=>{ document.getElementById('profileModal').classList.add('hidden'); showProfiles(); });
  };

  // ---------- Board Rendering ----------
  let currentParent = null;
  let editMode = false;
  async function loadBoard() {
    document.getElementById('userNameDisplay').textContent = currentProfile.name;
    document.getElementById('title').textContent = 'Teddy Board';
    renderBoard();
  }
  async function renderBoard() {
    const grid = document.getElementById('itemsGrid'); grid.innerHTML='';
    const items = await getItemsByProfile(currentProfile.id);
    const visible = items.filter(it=>it.parentId===currentParent);
    visible.forEach(item=>{
      const c = document.createElement('div');
      c.className='bg-white dark:bg-gray-800 p-4 rounded-xl shadow card-hover relative';
      const img = document.createElement('img'); img.src=item.image; img.className='w-16 h-16 mx-auto rounded mb-2';
      const lbl = document.createElement('div'); lbl.textContent=item.name; lbl.className='font-bold text-center';
      c.append(img,lbl);
      c.onclick = ()=>{
        if(editMode) return editItem(item);
        if(item.type==='category') { currentParent=item.id; renderBoard(); } else speak(item.name);
      };
      if(editMode) {
        const dbtn = document.createElement('button'); dbtn.textContent='×'; dbtn.className='absolute top-1 right-1';
        dbtn.onclick = e=>{ e.stopPropagation(); if(confirm(`Delete ${item.name}?`)) del('items',item.id).then(renderBoard); };
        c.append(dbtn);
      }
      grid.append(c);
    });
  }
  function editItem(item) {
    // reuse add form for edit (left as future code)
  }

  document.getElementById('editModeBtn').onclick = ()=>{
    const pw = prompt('Enter edit password');
    if(pw===currentProfile.password) { editMode = !editMode; renderBoard(); }
    else alert('Incorrect');
  };
  document.getElementById('backBtn').onclick = ()=>{ currentParent=null; renderBoard(); };

  // ---------- Initialize ----------
  showProfiles();
}
</script>

<!-- Profile Overlay -->
<div id="profileOverlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
  <div class="bg-white dark:bg-gray-800 p-6 rounded-xl w-full max-w-md">
    <h2 class="text-xl font-bold mb-4 text-center">Select Profile</h2>
    <div id="profileList" class="space-y-2 mb-4"></div>
    <button id="newProfileBtn" class="w-full bg-primary text-white p-3 rounded">+ Create Profile</button>
  </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
  <div class="bg-white dark:bg-gray-800 p-6 rounded-xl w-full max-w-md">
    <h2 id="profileModalTitle" class="text-xl font-bold mb-4 text-center"></h2>
    <input id="profileName" type="text" placeholder="Name" class="w-full p-3 border rounded mb-2">
    <input id="profileEmail" type="email" placeholder="Email (optional)" class="w-full p-3 border rounded mb-2">
    <input id="profilePassword" type="password" placeholder="Password" class="w-full p-3 border rounded mb-2">
    <input id="profileQuestion" type="text" placeholder="Security Question" class="w-full p-3 border rounded mb-2">
    <input id="profileAnswer" type="text" placeholder="Answer" class="w-full p-3 border rounded mb-4">
    <button id="saveProfileBtn" class="w-full bg-primary text-white p-3 rounded mb-2">Save</button>
    <button id="cancelProfileBtn" class="w-full bg-gray-300 p-3 rounded">Cancel</button>
  </div>
</div>

<!-- App Header -->
<header class="bg-primary text-white p-4 shadow fixed w-full top-0 z-40 flex justify-between items-center">
  <div class="flex items-center space-x-3">
    <button id="backBtn" class="hidden p-2 bg-white bg-opacity-20 rounded"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
    <h1 id="title" class="text-xl font-bold">Teddy Board</h1>
  </div>
  <div class="flex items-center space-x-2">
    <span id="userNameDisplay" class="font-medium"></span>
    <select id="themeSelector" class="p-2 bg-white bg-opacity-20 text-white rounded focus:outline-none">
      <option value="theme-default">Theme</option>
      <option value="theme-ocean">Ocean</option>
      <option value="theme-forest">Forest</option>
      <option value="theme-sunset">Sunset</option>
      <option value="theme-lavender">Lavender</option>
      <option value="theme-coral">Coral</option>
      <option value="theme-teal">Teal</option>
    </select>
    <select id="voiceSelector" class="p-2 bg-white bg-opacity-20 text-white rounded focus:outline-none">
      <option>Loading voices...</option>
    </select>
    <button id="settingsBtn" class="p-2 bg-white bg-opacity-20 rounded"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg></button>
    <button id="editModeBtn" class="p-2 bg-white bg-opacity-20 rounded" title="Edit Mode"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5" /></svg></button>
  </div>
</header>

<!-- Main Content -->
<div class="pt-20">
  <div id="breadcrumb" class="max-w-4xl mx-auto p-4"><ol class="flex space-x-2 text-gray-600 dark:text-gray-300"></ol></div>
  <div id="itemsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-w-4xl mx-auto p-4"></div>
</div>

</body>
</html>
